<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDTRIX | My Stats</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0056b3; --accent: #00a8cc; --bg: #f4f7f6; --card-bg: #ffffff; --text: #333; }
        [data-theme="dark"] { --primary: #bb86fc; --accent: #03dac6; --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 10px; }
        .back-btn { text-decoration: none; color: var(--text); font-weight: bold; border: 1px solid var(--text); padding: 8px 15px; border-radius: 20px; transition: 0.2s; }
        .back-btn:hover { background: var(--text); color: var(--bg); }

        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .stat-num { font-size: 3rem; font-weight: bold; color: var(--primary); margin: 5px 0; }
        .stat-label { font-size: 0.9rem; opacity: 0.7; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* CHART */
        .chart-section { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; height: 350px; position: relative; }

        /* LIST */
        .list-section { background: var(--card-bg); padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .list-item:last-child { border-bottom: none; }
        .item-name { font-weight: 600; font-size: 1.1rem; }
        .item-bar-container { flex-grow: 1; margin: 0 20px; background: rgba(128,128,128,0.1); height: 8px; border-radius: 4px; overflow: hidden; }
        .item-bar { height: 100%; background: var(--accent); border-radius: 4px; }
        .item-count { font-weight: bold; color: var(--accent); min-width: 80px; text-align: right; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <a href="index.html" class="back-btn">‚Üê Home</a>
        <h1>üìä Performance Report</h1>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Notes Read</div>
            <div class="stat-num" id="notesCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Quizzes Solved</div>
            <div class="stat-num" id="quizCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Completion</div>
            <div class="stat-num" id="totalPercent">0%</div>
        </div>
    </div>

    <div class="chart-section">
        <canvas id="mainChart"></canvas>
    </div>

    <div class="list-section">
        <h3 style="margin-top:0">Subject Breakdown</h3>
        <div id="breakdownList"></div>
    </div>
</div>

<script>
    // DARK MODE
    if(localStorage.getItem('medtrix-theme') === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        Chart.defaults.color = '#bbb';
        Chart.defaults.borderColor = '#444';
    }

    // DATA LOGIC
    const subjects = {};
    let totalNotes = 0;
    let totalQuizzes = 0;

    function detectSubject(name) {
        name = name.toLowerCase();
        if(name.includes('neuro')) return 'Neuroanatomy';
        if(name.includes('cardio')) return 'Cardiology';
        if(name.includes('renal') || name.includes('kidney')) return 'Renal';
        if(name.includes('ortho')) return 'Orthopedics';
        if(name.includes('surg')) return 'Surgery';
        if(name.includes('derma')) return 'Dermatology';
        if(name.includes('pedia')) return 'Pediatrics';
        if(name.includes('obs') || name.includes('gyn')) return 'OBG';
        if(name.includes('prep')) return 'Prepladder'; 
        if(name.includes('cereb')) return 'Cerebellum';
        if(name.includes('dams')) return 'DAMS';
        return 'General';
    }

    // SCAN LOCAL STORAGE
    for(let i=0; i<localStorage.length; i++) {
        const key = localStorage.key(i);
        const val = localStorage.getItem(key);
        
        if(val !== 'true') continue;

        // 1. NOTES (Keys start with read_)
        if(key.startsWith('read_')) {
            totalNotes++;
            let subj = detectSubject(key.replace('read_',''));
            subjects[subj] = (subjects[subj] || 0) + 1;
        }
        // 2. QUIZZES (HTML files)
        else if(key.endsWith('.html')) {
            totalQuizzes++;
            let subj = detectSubject(key);
            subjects[subj] = (subjects[subj] || 0) + 1;
        }
    }

    // UPDATE UI
    document.getElementById('notesCount').innerText = totalNotes;
    document.getElementById('quizCount').innerText = totalQuizzes;
    
    // Assuming ~200 total items for percentage calc
    let completion = Math.min(100, Math.round(((totalNotes + totalQuizzes) / 200) * 100));
    document.getElementById('totalPercent').innerText = completion + "%";

    // RENDER LIST
    let listHtml = "";
    for(const [subj, count] of Object.entries(subjects)) {
        // Arbitrary scale for visual bar
        let width = Math.min(100, (count / 20) * 100); 
        listHtml += `
        <div class="list-item">
            <div class="item-name">${subj}</div>
            <div class="item-bar-container">
                <div class="item-bar" style="width:${width}%"></div>
            </div>
            <div class="item-count">${count} done</div>
        </div>`;
    }
    if(listHtml === "") listHtml = "<div style='text-align:center; opacity:0.6; padding:20px'>No activity recorded yet.</div>";
    document.getElementById('breakdownList').innerHTML = listHtml;

    // RENDER CHART
    const ctx = document.getElementById('mainChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(subjects),
            datasets: [{
                data: Object.values(subjects),
                backgroundColor: [
                    '#0056b3', '#00a8cc', '#ff9800', '#e91e63', '#4caf50', '#9c27b0'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });

</script>
</body>
</html>
