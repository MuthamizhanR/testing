<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Recall</title>
    <style>
        /* Same theme variables for consistency */
        :root { --bg: #f4f7f6; --card: #fff; --text: #333; --primary: #0056b3; }
        [data-theme="dark"] { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; }

        body { background: var(--bg); color: var(--text); font-family: system-ui; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        header { padding: 15px; text-align: center; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        #flashcard-container {
            flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; perspective: 1000px;
        }

        .card {
            width: 100%; max-width: 600px; height: 400px;
            background: var(--card); border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative; cursor: pointer;
            transform-style: preserve-3d; transition: transform 0.6s;
            display: flex; align-items: center; justify-content: center;
            padding: 30px; text-align: center;
        }
        .card.flipped { transform: rotateY(180deg); }

        .front, .back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
            border-radius: 20px;
        }

        .back { transform: rotateY(180deg); background: #f0f9ff; color: #0f172a; overflow-y: auto; }
        [data-theme="dark"] .back { background: #2d3748; color: white; }

        .q-text { font-size: 1.2rem; font-weight: 600; }
        .ans-text { font-size: 1rem; line-height: 1.6; text-align: left; width: 100%; }

        .controls { display: flex; justify-content: center; gap: 20px; padding: 30px; }
        .btn { padding: 12px 24px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-know { background: #10b981; color: white; }
        .btn-dunno { background: #ef4444; color: white; }
        .btn:active { transform: scale(0.95); }

        .hidden { display: none; }
        
        #empty-state { text-align: center; margin-top: 100px; }
    </style>
</head>
<body>

<header>
    <h2>Active Recall Session</h2>
    <a href="index.html" style="text-decoration:none; font-size:0.9rem; color:grey;">Exit</a>
</header>

<div id="flashcard-container">
    <div id="card" class="card hidden" onclick="this.classList.toggle('flipped')">
        <div class="front">
            <div style="font-size:0.8rem; color:grey; margin-bottom:10px;">Tap to flip</div>
            <div id="front-text" class="q-text"></div>
        </div>
        <div class="back">
            <h3 style="color:var(--primary); margin-bottom:10px;">Correct Answer</h3>
            <div id="back-text" class="ans-text"></div>
        </div>
    </div>
    
    <div id="empty-state" class="hidden">
        <h3>ðŸŽ‰ All Caught Up!</h3>
        <p>You have no incorrect questions to review.</p>
        <a href="qbanks.html">Go practice more questions</a>
    </div>
</div>

<div class="controls hidden" id="controls">
    <button class="btn btn-dunno" onclick="nextCard(false)">Still Hard</button>
    <button class="btn btn-know" onclick="nextCard(true)">I Know It</button>
</div>

<script>
    // Load only incorrect questions
    let allData = JSON.parse(localStorage.getItem("medtrix_analytics") || "[]");
    let reviewQueue = allData.filter(q => !q.isCorrect);
    let currentIndex = 0;

    if(reviewQueue.length > 0) {
        document.getElementById('card').classList.remove('hidden');
        document.getElementById('controls').classList.remove('hidden');
        showCard();
    } else {
        document.getElementById('empty-state').classList.remove('hidden');
    }

    function showCard() {
        const item = reviewQueue[currentIndex];
        document.getElementById('front-text').innerHTML = item.text;
        
        // Find correct option text
        const correctOpt = item.options.find(o => o.correct)?.text || "Answer not found";
        
        document.getElementById('back-text').innerHTML = `
            <strong>Answer:</strong> ${correctOpt}
            <hr style="border:0; border-top:1px solid #ccc; margin:15px 0;">
            <div style="font-size:0.9rem">${item.explanation}</div>
        `;
        
        // Reset Flip
        document.getElementById('card').classList.remove('flipped');
    }

    function nextCard(known) {
        if(known) {
            // Mark as correct in DB so it doesn't show again
            const item = reviewQueue[currentIndex];
            const dbIndex = allData.findIndex(i => i.uid === item.uid);
            if(dbIndex !== -1) {
                allData[dbIndex].isCorrect = true; // Mark as mastered
                localStorage.setItem("medtrix_analytics", JSON.stringify(allData));
            }
        }

        currentIndex++;
        if(currentIndex < reviewQueue.length) {
            showCard();
        } else {
            location.reload(); // Refresh to show empty state
        }
    }

    if(localStorage.getItem('medtrix-theme') === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
    }
</script>

</body>
</html>