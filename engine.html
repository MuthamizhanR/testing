<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEDTRIX Pro Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-app: #f0f2f5; --bg-card: #ffffff; --bg-header: #ffffff;
            --text-primary: #111827; --text-secondary: #6b7280;
            --accent: #6366f1; --accent-soft: #e0e7ff;
            --border: #e5e7eb;
            --success: #10b981; --success-soft: #d1fae5;
            --error: #ef4444; --error-soft: #fee2e2;
            --radius: 16px; --shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .dark {
            --bg-app: #0f172a; --bg-card: #1e293b; --bg-header: #1e293b;
            --text-primary: #f3f4f6; --text-secondary: #94a3b8;
            --accent: #818cf8; --accent-soft: #312e81;
            --border: #334155;
            --success: #34d399; --success-soft: #064e3b;
            --error: #f87171; --error-soft: #7f1d1d;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-app); color: var(--text-primary); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { height: 60px; background: var(--bg-header); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; z-index: 50; }
        .brand { font-weight: 800; font-size: 1.2rem; color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .icon-btn { background: none; border: none; padding: 8px; border-radius: 50%; color: var(--text-primary); cursor: pointer; }

        /* --- DASHBOARD --- */
        #view-dashboard { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* MOCK TILE STYLE */
        .mock-tile {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            color: white; padding: 25px; border-radius: var(--radius);
            margin-bottom: 30px; text-align: center;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }
        .mock-btn {
            background: white; color: var(--accent); border: none;
            padding: 12px 30px; font-weight: 800; border-radius: 99px;
            cursor: pointer; font-size: 1rem; margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.2s;
        }

        /* SEARCH & LIST */
        .search-bar { width: 100%; padding: 14px 20px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 1rem; margin-bottom: 20px; outline: none; }
        .category-group { margin-bottom: 16px; background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        .group-header { padding: 16px 20px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .group-count { background: var(--accent-soft); color: var(--accent); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }
        .test-list { display: none; border-top: 1px solid var(--border); }
        .category-group.open .test-list { display: block; }
        .test-item { padding: 14px 20px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; }
        .test-item:hover { background: var(--accent-soft); }

        /* --- QUIZ VIEW --- */
        #view-quiz { position: fixed; inset: 0; background: var(--bg-app); z-index: 100; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease; }
        #view-quiz.active { transform: translateX(0); }

        .quiz-header { height: 60px; background: var(--bg-header); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; gap: 16px; }
        .back-btn { background: none; border: none; font-weight: 600; cursor: pointer; color: var(--text-secondary); font-size: 1rem; }
        .quiz-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700; text-align: center; }
        .timer-badge { background: var(--error-soft); color: var(--error); padding: 4px 12px; border-radius: 99px; font-weight: 700; font-family: monospace; display: none; }
        
        .quiz-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        .q-card { max-width: 800px; margin: 0 auto; background: var(--bg-card); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow); }
        
        /* QUESTION STYLES */
        .q-text { font-size: 1.15rem; font-weight: 600; line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap; }
        .q-img { max-width: 100%; max-height: 400px; border-radius: 8px; margin: 10px auto; border: 1px solid var(--border); display: block; }
        .opt-btn { 
            width: 100%; text-align: left; padding: 16px; background: var(--bg-card); 
            border: 2px solid var(--border); border-radius: 12px; margin-bottom: 10px;
            font-size: 1rem; color: var(--text-primary); cursor: pointer; 
            display: flex; gap: 12px; transition: 0.1s; 
        }
        .opt-btn:hover:not(:disabled) { border-color: var(--accent); background: var(--accent-soft); }
        
        .opt-btn.correct { border-color: var(--success); background: var(--success-soft); color: #064e3b; }
        .opt-btn.wrong { border-color: var(--error); background: var(--error-soft); color: #7f1d1d; }
        .opt-btn.selected { border-color: var(--accent); background: var(--accent); color: white; }

        /* EXPLANATION */
        .exp-section { margin-top: 24px; border-top: 1px solid var(--border); padding-top: 20px; display: none; }
        .exp-section.show { display: block; }
        .ai-btn { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; padding: 6px 14px; border-radius: 99px; font-size: 0.8rem; cursor: pointer; float: right; }
        .ai-response { margin-top: 15px; padding: 15px; background: var(--bg-app); border-radius: 12px; border: 1px solid var(--accent); display: none; }

        /* FOOTER */
        .quiz-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: var(--bg-header); border-top: 1px solid var(--border); display: flex; padding: 10px 20px; gap: 15px; justify-content: center; align-items: center; }
        .nav-btn { flex: 1; max-width: 180px; height: 50px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; font-size: 1rem; }
        .btn-sec { background: var(--bg-app); border: 1px solid var(--border); color: var(--text-primary); }
        .btn-pri { background: var(--accent); color: white; }
        .btn-submit { background: var(--error); color: white; display: none; }

        /* LOADING & MODALS */
        #loading-overlay { position: fixed; inset: 0; background: var(--bg-app); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--accent-soft); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-card { background: var(--bg-card); width: 90%; max-width: 400px; padding: 30px; border-radius: 24px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<!-- LOADER -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <h3 id="loading-text" style="margin-top:20px;">Loading...</h3>
</div>

<!-- HEADER -->
<header>
    <a href="#" onclick="location.reload()" class="brand">MEDTRIX <span style="color:var(--text-secondary); font-weight:400;">Engine</span></a>
    <button class="icon-btn" onclick="toggleTheme()">üåó</button>
</header>

<!-- DASHBOARD (Switches between Mock and List) -->
<div id="view-dashboard">
    
    <!-- MOCK MODE -->
    <div id="sec-mock" style="display:none;">
        <div class="mock-tile">
            <h2 style="margin:0; font-size:1.8rem;">Grand Mock Exam</h2>
            <p style="opacity:0.9; margin:10px 0;">200 Questions ‚Ä¢ 3 Hours ‚Ä¢ NEET PG Pattern</p>
            <p style="font-size:0.9rem; opacity:0.8;">Intelligent generator uses subject weightage (Surgery 21, Medicine 20...)</p>
            <button class="mock-btn" onclick="generateMockTest()">Start 200Q Mock</button>
        </div>
    </div>

    <!-- LIST MODE -->
    <div id="sec-list" style="display:none;">
        <h2 style="margin-bottom:15px; color:var(--accent);">Subject Tests</h2>
        <input type="text" id="search" class="search-bar" placeholder="Search individual tests..." onkeyup="filterIndex()">
        <div id="index-container"></div>
    </div>

</div>

<!-- QUIZ VIEW (The elements causing your error are here) -->
<div id="view-quiz">
    <div class="quiz-header">
        <button class="back-btn" onclick="confirmExit()">Exit</button>
        <!-- THESE IDs MUST EXIST: q-title, timer-disp -->
        <div class="quiz-title" id="q-title">Test</div>
        <div class="timer-badge" id="timer-disp">00:00:00</div>
    </div>
    
    <div class="quiz-content">
        <div class="q-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:var(--text-secondary); font-size:0.9rem;">
                <!-- THESE IDs MUST EXIST: q-num, q-id-disp -->
                <span id="q-num">1 / 10</span>
                <span id="q-id-disp" style="font-family:monospace;"></span>
            </div>

            <div class="q-text" id="q-text"></div>
            <div id="q-media"></div>
            <div id="q-options"></div>

            <div class="exp-section" id="q-exp">
                <div class="exp-title">
                    Explanation
                    <button class="ai-btn" onclick="askAI()">‚ú® Ask AI</button>
                </div>
                <div class="exp-content" id="exp-text"></div>
                <div class="ai-response" id="ai-result"></div>
            </div>
        </div>
    </div>

    <div class="quiz-footer">
        <button class="nav-btn btn-sec" onclick="move(-1)">Previous</button>
        <button class="nav-btn btn-pri" id="btn-next" onclick="move(1)">Next</button>
        <button class="nav-btn btn-submit" id="btn-submit" onclick="finishMock()">Submit Exam</button>
    </div>
</div>

<!-- RESULT MODAL -->
<div class="modal-overlay" id="result-modal">
    <div class="modal-card">
        <h2 style="margin-top:0;">Exam Result</h2>
        <div style="font-size:3.5rem; font-weight:800; color:var(--accent); margin:10px 0;" id="final-score">0</div>
        <p style="color:var(--text-secondary);">Out of 800 Marks</p>
        <div style="display:flex; justify-content:space-around; margin:20px 0; background:var(--bg-app); padding:15px; border-radius:12px;">
            <div><strong style="color:var(--success); display:block; font-size:1.2rem;" id="res-c">0</strong>Correct</div>
            <div><strong style="color:var(--error); display:block; font-size:1.2rem;" id="res-w">0</strong>Wrong</div>
            <div><strong style="color:var(--text-secondary); display:block; font-size:1.2rem;" id="res-u">0</strong>Skip</div>
        </div>
        <button class="mock-btn" style="background:var(--accent); color:white; width:100%;" onclick="closeResult()">Review Answers</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_KEYS = ["YOUR_API_KEY_HERE"]; 

    const MOCK_PLAN = {
        "Surgery": 21, "Medicine": 20, "Pharmacology": 17, "Microbiology": 16, 
        "Pathology": 15, "OBGYN": 15, "Community Medicine": 13, "Biochemistry": 11, 
        "Anatomy": 10, "Forensic": 9, "Pediatrics": 9, "Radiology": 7, "ENT": 7, 
        "Dermatology": 6, "Psychiatry": 5, "Orthopedics": 5, "Physiology": 5, 
        "Ophthalmology": 5, "Anesthesia": 4
    };

    // --- STATE ---
    let manifest = [];
    let questionBank = [];
    let userAnswers = {}; 
    let curIdx = 0;
    let isMockMode = false;
    let isReviewMode = false;
    let timerInterval;
    let timeRemaining = 10800;

    document.addEventListener('DOMContentLoaded', () => {
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
        
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode');
        if (mode === 'list') {
            document.getElementById('sec-list').style.display = 'block';
            document.getElementById('sec-mock').style.display = 'none';
        } else {
            document.getElementById('sec-mock').style.display = 'block';
            document.getElementById('sec-list').style.display = 'none';
        }

        loadManifest();
    });

    // --- HELPER: SAFE URL BUILDER ---
    function getSafeUrl(filename) {
        let cleanName = filename.replace(/^quiz_data\//, '');
        return `quiz_data/${encodeURIComponent(cleanName)}`;
    }

    async function loadManifest() {
        try {
            const res = await fetch('manifest.json');
            if(!res.ok) throw new Error(`HTTP ${res.status}`);
            manifest = await res.json();
            renderIndex(manifest);
        } catch(e) {
            const container = document.getElementById('index-container');
            if(container) container.innerHTML = `<p style="color:red; text-align:center;">Error loading manifest: ${e.message}</p>`;
        }
    }

    // --- INDEX RENDER ---
    function renderIndex(list) {
        const container = document.getElementById('index-container');
        if(!container) return;
        container.innerHTML = "";
        
        const groups = list.reduce((acc, item) => {
            const cat = item.category || "Other";
            if(!acc[cat]) acc[cat] = [];
            acc[cat].push(item);
            return acc;
        }, {});

        Object.keys(groups).sort().forEach((cat) => {
            const itemsHtml = groups[cat].map(t => `
                <li class="test-item" onclick="openPracticeTest('${t.file.replace(/'/g, "\\'")}')">
                    <span>${t.title}</span>
                    <span style="font-size:0.8rem; color:var(--text-secondary);">${t.questions} Qs</span>
                </li>
            `).join('');

            container.innerHTML += `
                <div class="category-group">
                    <div class="group-header" onclick="this.parentElement.classList.toggle('open')">
                        ${cat} <span class="group-count">${groups[cat].length}</span>
                    </div>
                    <ul class="test-list">${itemsHtml}</ul>
                </div>
            `;
        });
    }

    function filterIndex() {
        const term = document.getElementById('search').value.toLowerCase();
        if(!term) { renderIndex(manifest); return; }
        const filtered = manifest.filter(t => t.title.toLowerCase().includes(term));
        renderIndex(filtered);
        document.querySelectorAll('.category-group').forEach(g => g.classList.add('open'));
    }

    // --- FIXED PRACTICE MODE ---
    async function openPracticeTest(filename) {
        showLoader(true, "Loading Test...");
        try {
            isMockMode = false;
            isReviewMode = false;
            userAnswers = {};
            
            const url = getSafeUrl(filename);
            const res = await fetch(url);
            
            if(!res.ok) throw new Error(`File not found (${res.status})`);
            
            const data = await res.json();
            questionBank = data.questions;
            startSession(data.title);
        } catch(e) {
            alert(`Failed to load test.\nError: ${e.message}`);
            console.error(e);
        } finally { showLoader(false); }
    }

    // --- FIXED GRAND MOCK GENERATOR ---
    async function generateMockTest() {
        showLoader(true, "Generating 200 Questions...");
        isMockMode = true;
        isReviewMode = false;
        userAnswers = {};
        let finalQs = [];
        
        try {
            const fetchFile = async (f) => {
                try { 
                    const r = await fetch(getSafeUrl(f)); 
                    if(!r.ok) return null;
                    return await r.json(); 
                } catch(e) { return null; }
            };

            // 1. TARGETED FETCHING
            for(let [subj, count] of Object.entries(MOCK_PLAN)) {
                const candidates = manifest.filter(m => 
                    (m.category && m.category.toLowerCase().includes(subj.toLowerCase())) || 
                    m.title.toLowerCase().includes(subj.toLowerCase())
                );

                if(candidates.length === 0) continue;

                candidates.sort(() => 0.5 - Math.random());
                const filesToFetch = candidates.slice(0, 20); 

                const promises = filesToFetch.map(c => fetchFile(c.file));
                const results = await Promise.all(promises);

                let subjectQs = [];
                results.forEach(data => {
                    if(data && data.questions) subjectQs.push(...data.questions);
                });

                subjectQs = subjectQs.filter((q, index, self) =>
                    index === self.findIndex((t) => (t.uid === q.uid))
                );

                subjectQs.sort(() => 0.5 - Math.random());
                finalQs.push(...subjectQs.slice(0, count));
            }

            // 2. BACKFILL
            if(finalQs.length < 200) {
                const needed = 200 - finalQs.length;
                const spareFiles = manifest.sort(() => 0.5 - Math.random()).slice(0, 50);
                const sparePromises = spareFiles.map(f => fetchFile(f.file));
                const spareResults = await Promise.all(sparePromises);
                
                let sparePool = [];
                spareResults.forEach(d => { if(d && d.questions) sparePool.push(...d.questions); });

                const existingIds = new Set(finalQs.map(q => q.uid));
                const uniqueSpares = sparePool.filter(q => !existingIds.has(q.uid));

                finalQs.push(...uniqueSpares.slice(0, needed));
            }

            questionBank = finalQs.sort(() => 0.5 - Math.random());
            
            if(questionBank.length === 0) {
                alert("Error: No questions loaded.");
                return;
            }

            startSession("Grand Mock Exam");

        } catch(e) {
            alert("Error generating mock: " + e.message);
        } finally { showLoader(false); }
    }

    // --- SESSION MANAGEMENT ---
    function startSession(title) {
        curIdx = 0;
        
        // CRITICAL: These lookups are where your error came from.
        // They will work now because the IDs exist in the HTML above.
        const titleEl = document.getElementById('q-title');
        if(titleEl) titleEl.textContent = title;
        
        const quizView = document.getElementById('view-quiz');
        if(quizView) quizView.classList.add('active');
        
        const timerBadge = document.getElementById('timer-disp');
        const submitBtn = document.getElementById('btn-submit');
        const nextBtn = document.getElementById('btn-next');

        if(isMockMode) {
            if(timerBa        /* --- DASHBOARD --- */
        #view-dashboard { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* NEW: MOCK TILE STYLE */
        .mock-tile {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            color: white; padding: 25px; border-radius: var(--radius);
            margin-bottom: 30px; text-align: center;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
            position: relative; overflow: hidden;
        }
        .mock-btn {
            background: white; color: var(--accent); border: none;
            padding: 12px 30px; font-weight: 800; border-radius: 99px;
            cursor: pointer; font-size: 1rem; margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .mock-btn:hover { transform: scale(1.05); }

        /* SEARCH & LIST */
        .search-bar { width: 100%; padding: 14px 20px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 1rem; margin-bottom: 20px; outline: none; }
        .category-group { margin-bottom: 16px; background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        .group-header { padding: 16px 20px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .group-count { background: var(--accent-soft); color: var(--accent); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }
        .test-list { display: none; border-top: 1px solid var(--border); }
        .category-group.open .test-list { display: block; }
        .test-item { padding: 14px 20px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; }
        .test-item:hover { background: var(--accent-soft); }

        /* --- QUIZ VIEW --- */
        #view-quiz { position: fixed; inset: 0; background: var(--bg-app); z-index: 100; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease; }
        #view-quiz.active { transform: translateX(0); }

        .quiz-header { height: 60px; background: var(--bg-header); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; gap: 16px; }
        .back-btn { background: none; border: none; font-weight: 600; cursor: pointer; color: var(--text-secondary); }
        .timer-badge { background: var(--error-soft); color: var(--error); padding: 4px 12px; border-radius: 99px; font-weight: 700; font-family: monospace; display: none; }
        
        .quiz-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        .q-card { max-width: 800px; margin: 0 auto; background: var(--bg-card); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow); }
        
        /* QUESTION STYLES */
        .q-text { font-size: 1.15rem; font-weight: 600; line-height: 1.6; margin-bottom: 20px; }
        .q-img { max-width: 100%; max-height: 400px; border-radius: 8px; margin: 10px auto; border: 1px solid var(--border); display: block; }
        .opt-btn { 
            width: 100%; text-align: left; padding: 16px; background: var(--bg-card); 
            border: 2px solid var(--border); border-radius: 12px; margin-bottom: 10px;
            font-size: 1rem; color: var(--text-primary); cursor: pointer; 
            display: flex; gap: 12px; transition: 0.1s; 
        }
        .opt-btn:hover:not(:disabled) { border-color: var(--accent); background: var(--accent-soft); }
        
        /* FEEDBACK STYLES */
        .opt-btn.correct { border-color: var(--success); background: var(--success-soft); color: #064e3b; }
        .opt-btn.wrong { border-color: var(--error); background: var(--error-soft); color: #7f1d1d; }
        .opt-btn.selected { border-color: var(--accent); background: var(--accent); color: white; } /* For Mock Mode */

        /* EXPLANATION */
        .exp-section { margin-top: 24px; border-top: 1px solid var(--border); padding-top: 20px; display: none; }
        .exp-section.show { display: block; }
        .ai-btn { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; padding: 6px 14px; border-radius: 99px; font-size: 0.8rem; cursor: pointer; float: right; }
        .ai-response { margin-top: 15px; padding: 15px; background: var(--bg-app); border-radius: 12px; border: 1px solid var(--accent); display: none; }

        /* FOOTER */
        .quiz-footer { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: var(--bg-header); border-top: 1px solid var(--border); display: flex; padding: 10px 20px; gap: 15px; justify-content: center; align-items: center; }
        .nav-btn { flex: 1; max-width: 180px; height: 50px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; font-size: 1rem; }
        .btn-sec { background: var(--bg-app); border: 1px solid var(--border); color: var(--text-primary); }
        .btn-pri { background: var(--accent); color: white; }
        .btn-submit { background: var(--error); color: white; display: none; }

        /* RESULT MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-card { background: var(--bg-card); width: 90%; max-width: 400px; padding: 30px; border-radius: 24px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        
        /* LOADING */
        #loading-overlay { position: fixed; inset: 0; background: var(--bg-app); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--accent-soft); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <h3 style="margin-top:20px;">Building Test...</h3>
    <p id="loading-text" style="color:var(--text-secondary);">Crawling database...</p>
</div>

<header>
    <a href="#" onclick="location.reload()" class="brand">
        MEDTRIX <span style="color:var(--text-secondary); font-weight:400;">Engine</span>
    </a>
    <button class="icon-btn" onclick="toggleTheme()">üåó</button>
</header>

<div id="view-dashboard">
    
    <!-- SECTION 1: MOCK BANNER (Hidden by default) -->
    <div id="sec-mock" style="display:none;">
        <div class="mock-tile">
            <h2 style="margin:0; font-size:1.8rem;">Grand Mock Exam</h2>
            <p style="opacity:0.9; margin:10px 0;">200 Questions ‚Ä¢ 3 Hours ‚Ä¢ NEET PG Pattern</p>
            <p style="font-size:0.9rem; opacity:0.8;">Intelligent generator uses subject weightage (Surgery 21, Medicine 20...)</p>
            <button class="mock-btn" onclick="generateMockTest()">Start 200Q Mock</button>
        </div>
    </div>

    <!-- SECTION 2: SUBJECT LIST (Hidden by default) -->
    <div id="sec-list" style="display:none;">
        <h2 style="margin-bottom:15px; color:var(--accent);">Subject Tests</h2>
        <input type="text" id="search" class="search-bar" placeholder="Search individual tests (e.g. DAMS, Surgery)..." onkeyup="filterIndex()">
        <div id="index-container"></div>
    </div>

</div>

<script>
    // --- CONFIGURATION ---
    const API_KEYS = ["AIzaSyAOuk5NbH0O1MFAQypnD8Ia9MNfFo6aVDc"]; 

    const MOCK_PLAN = {
        "Surgery": 21, "Medicine": 20, "Pharmacology": 17, "Microbiology": 16, 
        "Pathology": 15, "OBGYN": 15, "Community Medicine": 13, "Biochemistry": 11, 
        "Anatomy": 10, "Forensic": 9, "Pediatrics": 9, "Radiology": 7, "ENT": 7, 
        "Dermatology": 6, "Psychiatry": 5, "Orthopedics": 5, "Physiology": 5, 
        "Ophthalmology": 5, "Anesthesia": 4
    };

    // --- STATE ---
    let manifest = [];
    let questionBank = [];
    let userAnswers = {}; 
    let curIdx = 0;
    let isMockMode = false;
    let isReviewMode = false;
    let timerInterval;
    let timeRemaining = 10800;

    document.addEventListener('DOMContentLoaded', () => {
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
        
        // Handle Mode Switching
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode');
        if (mode === 'list') {
            document.getElementById('sec-list').style.display = 'block';
            document.getElementById('sec-mock').style.display = 'none';
        } else {
            document.getElementById('sec-mock').style.display = 'block';
            document.getElementById('sec-list').style.display = 'none';
        }

        loadManifest();
    });

    // --- HELPER: SAFE URL BUILDER ---
    function getSafeUrl(filename) {
        // 1. Remove 'quiz_data/' if it's already in the manifest entry
        let cleanName = filename.replace(/^quiz_data\//, '');
        // 2. Handle spaces and special characters (GitHub hates spaces in URLs)
        return `quiz_data/${encodeURIComponent(cleanName)}`;
    }

    async function loadManifest() {
        try {
            const res = await fetch('manifest.json');
            if(!res.ok) throw new Error(`HTTP ${res.status}`);
            manifest = await res.json();
            renderIndex(manifest);
        } catch(e) {
            document.getElementById('index-container').innerHTML = `<p style="color:red; text-align:center;">Error loading manifest: ${e.message}</p>`;
        }
    }

    // --- UPDATED: CATEGORIES COLLAPSED BY DEFAULT ---
    function renderIndex(list) {
        const container = document.getElementById('index-container');
        container.innerHTML = "";
        
        const groups = list.reduce((acc, item) => {
            const cat = item.category || "Other";
            if(!acc[cat]) acc[cat] = [];
            acc[cat].push(item);
            return acc;
        }, {});

        Object.keys(groups).sort().forEach((cat) => {
            const itemsHtml = groups[cat].map(t => `
                <li class="test-item" onclick="openPracticeTest('${t.file.replace(/'/g, "\\'")}')">
                    <span>${t.title}</span>
                    <span style="font-size:0.8rem; color:var(--text-secondary);">${t.questions} Qs</span>
                </li>
            `).join('');

            // Note: Removed 'open' class so it stays collapsed
            container.innerHTML += `
                <div class="category-group">
                    <div class="group-header" onclick="this.parentElement.classList.toggle('open')">
                        ${cat} <span class="group-count">${groups[cat].length}</span>
                    </div>
                    <ul class="test-list">${itemsHtml}</ul>
                </div>
            `;
        });
    }

    function filterIndex() {
        const term = document.getElementById('search').value.toLowerCase();
        if(!term) { renderIndex(manifest); return; }
        const filtered = manifest.filter(t => t.title.toLowerCase().includes(term));
        renderIndex(filtered);
        document.querySelectorAll('.category-group').forEach(g => g.classList.add('open'));
    }

    // --- FIXED PRACTICE MODE ---
    async function openPracticeTest(filename) {
        showLoader(true, "Loading Test...");
        try {
            isMockMode = false;
            isReviewMode = false;
            userAnswers = {};
            
            const url = getSafeUrl(filename);
            const res = await fetch(url);
            
            if(!res.ok) throw new Error(`File not found (${res.status}). URL: ${url}`);
            
            const data = await res.json();
            questionBank = data.questions;
            startSession(data.title);
        } catch(e) {
            alert(`Failed to load test.\nError: ${e.message}`);
            console.error(e);
        } finally { showLoader(false); }
    }

    // --- FIXED GRAND MOCK GENERATOR ---
    async function generateMockTest() {
        showLoader(true, "Generating 200 Questions...");
        isMockMode = true;
        isReviewMode = false;
        userAnswers = {};
        let finalQs = [];
        
        try {
            const fetchFile = async (f) => {
                try { 
                    const r = await fetch(getSafeUrl(f)); 
                    if(!r.ok) return null;
                    return await r.json(); 
                } catch(e) { return null; }
            };

            // 1. TARGETED FETCHING
            for(let [subj, count] of Object.entries(MOCK_PLAN)) {
                const candidates = manifest.filter(m => 
                    (m.category && m.category.toLowerCase().includes(subj.toLowerCase())) || 
                    m.title.toLowerCase().includes(subj.toLowerCase())
                );

                if(candidates.length === 0) continue;

                // Take up to 20 files per subject to find enough questions
                candidates.sort(() => 0.5 - Math.random());
                const filesToFetch = candidates.slice(0, 20); 

                const promises = filesToFetch.map(c => fetchFile(c.file));
                const results = await Promise.all(promises);

                let subjectQs = [];
                results.forEach(data => {
                    if(data && data.questions) subjectQs.push(...data.questions);
                });

                // Deduplicate
                subjectQs = subjectQs.filter((q, index, self) =>
                    index === self.findIndex((t) => (t.uid === q.uid))
                );

                subjectQs.sort(() => 0.5 - Math.random());
                finalQs.push(...subjectQs.slice(0, count));
            }

            // 2. BACKFILL IF SHORT
            if(finalQs.length < 200) {
                const needed = 200 - finalQs.length;
                console.log(`Short by ${needed} Qs. Backfilling...`);
                
                // Use entire manifest as pool
                const spareFiles = manifest.sort(() => 0.5 - Math.random()).slice(0, 50);
                const sparePromises = spareFiles.map(f => fetchFile(f.file));
                const spareResults = await Promise.all(sparePromises);
                
                let sparePool = [];
                spareResults.forEach(d => { if(d && d.questions) sparePool.push(...d.questions); });

                const existingIds = new Set(finalQs.map(q => q.uid));
                const uniqueSpares = sparePool.filter(q => !existingIds.has(q.uid));

                finalQs.push(...uniqueSpares.slice(0, needed));
            }

            questionBank = finalQs.sort(() => 0.5 - Math.random());
            
            if(questionBank.length === 0) {
                alert("Critical Error: Could not load ANY questions. Please check if 'quiz_data' folder exists.");
                return;
            }

            startSession("Grand Mock Exam");

        } catch(e) {
            alert("Error generating mock: " + e.message);
            console.error(e);
        } finally { showLoader(false); }
    }

    function startSession(title) {
        curIdx = 0;
        document.getElementById('q-title').textContent = title;
        document.getElementById('view-quiz').classList.add('active');
        
        // Update UI for Mock vs Practice
        const timerBadge = document.getElementById('timer-disp');
        const submitBtn = document.getElementById('btn-submit');
        const nextBtn = document.getElementById('btn-next');

        if(isMockMode) {
            timerBadge.style.display = 'block';
            submitBtn.style.display = 'block';
            nextBtn.textContent = "Next";
            timeRemaining = 180 * 60;
            startTimer();
        } else {
            timerBadge.style.display = 'none';
            submitBtn.style.display = 'none';
            nextBtn.textContent = "Next";
        }
        renderQuestion();
    }

    function renderQuestion() {
        const q = questionBank[curIdx];
        document.getElementById('q-num').textContent = `${curIdx + 1} / ${questionBank.length}`;
        document.getElementById('q-id-disp').textContent = `#${q.uid || 'ID'}`;
        document.getElementById('q-text').innerHTML = q.text;

        const mediaDiv = document.getElementById('q-media');
        mediaDiv.innerHTML = '';
        if(q.question_images) q.question_images.forEach(s => mediaDiv.innerHTML += `<img src="${s}" class="q-img">`);

        const optsDiv = document.getElementById('q-options');
        const savedAns = userAnswers[q.uid]; 

        optsDiv.innerHTML = q.options.map((opt, i) => {
            let cls = "opt-btn";
            if(isMockMode && !isReviewMode) {
                if(savedAns === i) cls += " selected";
            } else {
                if(opt.correct) cls += " correct";
                if(savedAns === i && !opt.correct) cls += " wrong";
            }
            const finalDisabled = isReviewMode ? 'disabled' : '';
            return `<button class="${cls}" onclick="handleAns(${i})" ${finalDisabled}>
                <div style="font-weight:bold;">${String.fromCharCode(65+i)}</div>
                <div>${opt.text}</div>
            </button>`;
        }).join('');

        const expDiv = document.getElementById('q-exp');
        const expText = document.getElementById('exp-text');
        document.getElementById('ai-result').style.display = 'none';

        if(!isMockMode || isReviewMode) {
            if(savedAns !== undefined || isReviewMode) {
                expDiv.classList.add('show');
                expText.innerHTML = q.explanation || "No explanation.";
            } else { expDiv.classList.remove('show'); }
        } else { expDiv.classList.remove('show'); }
        
        if(!isMockMode && curIdx === questionBank.length-1) document.getElementById('btn-next').textContent = "Finish";
    }

    function handleAns(idx) {
        const q = questionBank[curIdx];
        userAnswers[q.uid] = idx;
        renderQuestion();
    }

    function move(dir) {
        const next = curIdx + dir;
        if(next >= 0 && next < questionBank.length) {
            curIdx = next;
            renderQuestion();
        } else if (!isMockMode && next >= questionBank.length) {
            confirmExit();
        }
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeRemaining--;
            const h = Math.floor(timeRemaining / 3600);
            const m = Math.floor((timeRemaining % 3600) / 60);
            const s = timeRemaining % 60;
            document.getElementById('timer-disp').textContent = 
                `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if(timeRemaining <= 0) finishMock();
        }, 1000);
    }

    function finishMock() {
        clearInterval(timerInterval);
        isReviewMode = true; 
        let c = 0, w = 0, u = 0;
        questionBank.forEach(q => {
            const ans = userAnswers[q.uid];
            if(ans === undefined) u++;
            else if(q.options[ans].correct) c++;
            else w++;
        });
        document.getElementById('final-score').textContent = (c*4) - w;
        document.getElementById('res-c').textContent = c;
        document.getElementById('res-w').textContent = w;
        document.getElementById('res-u').textContent = u;
        document.getElementById('result-modal').style.display = 'flex';
        document.getElementById('btn-submit').style.display = 'none';
        renderQuestion();
    }

    function closeResult() { document.getElementById('result-modal').style.display = 'none'; }

    function confirmExit() {
        if(isMockMode && !isReviewMode) {
            if(!confirm("Exit exam? Progress will be lost.")) return;
        }
        document.getElementById('view-quiz').classList.remove('active');
        clearInterval(timerInterval);
        window.history.replaceState({}, '', window.location.pathname);
    }

    function showLoader(show, text) {
        const el = document.getElementById('loading-overlay');
        el.style.display = show ? 'flex' : 'none';
        if(text) document.getElementById('loading-text').textContent = text;
    }

    // --- ROBUST AI FUNCTION (With Fallbacks) ---
    async function askAI() {
        const q = questionBank[curIdx];
        const box = document.getElementById('ai-result');
        const btn = document.querySelector('.ai-btn');
        
        box.style.display = 'block';
        box.innerHTML = "‚ö° Thinking... (Gemini 2.0 Flash)";
        btn.disabled = true;

        const key = API_KEYS[Math.floor(Math.random() * API_KEYS.length)];
        const correctOpt = (q.options && q.options.find(o => o.correct)) ? q.options.find(o => o.correct).text : "N/A";
        const contextText = document.getElementById('exp-text') ? document.getElementById('exp-text').innerText.substring(0,1000) : "No context";

        const prompt = `
        You are a medical professor. Explain this NEET PG question.
        Question: ${q.text}
        Correct Answer: ${correctOpt}
        Context: ${contextText}
        Explain why the correct answer is right and why distractors are wrong.
        `;

        const callGemini = async (modelName) => {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        };

        try {
            try {
                const text = await callGemini("gemini-2.0-flash-exp");
                box.innerHTML = marked.parse(text) + `<div style="text-align:right; font-size:0.7rem; opacity:0.6; margin-top:5px;">Gemini 2.0 Flash</div>`;
            } catch (err) {
                box.innerHTML = "‚ö†Ô∏è 2.0 Busy, switching to Stable 1.5...<br>";
                const text = await callGemini("gemini-1.5-flash");
                box.innerHTML += marked.parse(text);
            }
        } catch(e) {
            box.innerHTML = `<span style="color:red">AI Error: ${e.message}</span>`;
        } finally {
            btn.disabled = false;
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('dark');
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    }
</script>

</body>
</html>
